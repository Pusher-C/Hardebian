################################################################################
# Debian Preseed Configuration
################################################################################

# LOCALIZATION
################################################################################
# Set locale to US English UTF-8
d-i debian-installer/locale string en_US.UTF-8
d-i debian-installer/language string en
d-i debian-installer/country string US
# Keyboard configuration - US layout
d-i keyboard-configuration/xkb-keymap select us
d-i keyboard-configuration/toggle select No toggling

################################################################################
# NETWORK CONFIGURATION
################################################################################
# Automatically select the network interface (usually eth0 or first available)
d-i netcfg/choose_interface select auto

# Hostname and domain configuration
# CUSTOMIZE: Change hostname to your preference in both lines below
d-i netcfg/get_hostname string hardened-debian
d-i netcfg/get_domain string

# Hostname fallback (must match get_hostname above)
d-i netcfg/hostname string hardened-debian
d-i netcfg/choose_interface select auto
d-i netcfg/disable_autoconfig boolean true
d-i netcfg/get_ipaddress string 192.168.88.190
d-i netcfg/get_netmask string 255.255.255.0
d-i netcfg/get_gateway string 192.168.88.1
d-i netcfg/get_nameservers string 192.168.88.1
d-i netcfg/confirm_static boolean true
d-i netcfg/get_hostname string local
d-i netcfg/get_domain string
d-i netcfg/hostname string debian-host

# Disable IPv6 during installation for security
d-i netcfg/disable_ipv6 boolean true

# Wireless configuration - disabled for security
d-i netcfg/wireless_wep string
d-i netcfg/wireless_essid string

################################################################################
# MIRROR SETTINGS
################################################################################
# Debian mirror configuration
d-i mirror/country string manual
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string

# Mirror suite (stable, testing, unstable)
d-i mirror/suite string testing

# Security updates mirror
d-i apt-setup/security_host string security.debian.org
d-i apt-setup/services-select multiselect security, updates

################################################################################
# ACCOUNT SETUP
################################################################################
# Root account configuration - DISABLE ROOT LOGIN for security
d-i passwd/root-login boolean false

# Regular user account - 'dev' user with sudo access
d-i passwd/user-fullname string Development User
d-i passwd/username string dev
# User password - REQUIRED: Must be set even if blank for installation to proceed
# When root-login is disabled, a user password is mandatory to define the system's
# authentication method. The password is set to blank here to allow automated installation.
# SECURITY NOTE: This creates a temporary vulnerability. The system relies on:
#   1. Network isolation during installation (configured above with static IP)
#   2. Post-install hardening via scripts in this repository:
#      - ./deb (main hardening script): Sets up U2F/YubiKey PAM auth, firewall, AppArmor, etc.
#      - ./advanced_deb (advanced hardening): Additional kernel integrity, capability stripping, etc.
#      Both scripts replace password authentication with U2F/YubiKey (pam_u2f.so) and
#      configure PAM to deny all password-based authentication attempts.
# CRITICAL TIMING: The blank password IS operational from first boot until hardening completes!
# IMPORTANT: Keep the system network-isolated and run ./deb IMMEDIATELY after first boot.
# Only after ./deb completes will password auth be replaced with U2F/YubiKey authentication.
# Until then, anyone with physical or network access could log in with no password.
d-i passwd/user-password password
d-i passwd/user-password-again password
d-i passwd/user-default-groups string sudo wheel

################################################################################
# TIME CONFIGURATION
################################################################################
# Timezone - UTC for servers, or customize to your location
d-i time/zone string UTC

# Hardware clock set to UTC
d-i clock-setup/utc boolean true

# NTP time synchronization (will be handled by chrony post-install)
d-i clock-setup/ntp boolean true
d-i clock-setup/ntp-server string time.cloudflare.com

################################################################################
# DISK PARTITIONING - ENCRYPTED LVM WITH SEPARATE PARTITIONS
################################################################################

# Target disk - CUSTOMIZE if not using /dev/nvme0n1
d-i partman-auto/disk string /dev/nvme0n1

# Use crypto method for full disk encryption with LVM
d-i partman-auto/method string crypto

# Remove any existing LVM/RAID configurations
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-md/device_remove_md boolean true

# LUKS encryption passphrase
# CUSTOMIZE: Change this passphrase before installation!
d-i partman-crypto/passphrase string changeme123
d-i partman-crypto/passphrase-again string changeme123

# Crypto confirmation settings
d-i partman-crypto/confirm boolean true
d-i partman-crypto/weak_passphrase boolean true

# LVM configuration
d-i partman-auto-lvm/guided_size string max
d-i partman-auto-lvm/new_vg_name string lvg

# Use the custom security-lvm recipe defined below
d-i partman-auto/choose_recipe select security-lvm

################################################################################
# CUSTOM PARTITION RECIPE - Security-hardened layout with encryption
################################################################################
# Creates: EFI, /boot (unencrypted), then encrypted LVM containing:
# /, /usr, /opt, /home, /var, /var/log, /var/log/audit
d-i partman-auto/expert_recipe string                         \
      security-lvm ::                                         \
              512 512 512 fat32                               \
                      $primary{ }                             \
                      $iflabel{ gpt }                         \
                      $reusemethod{ }                         \
                      method{ efi }                           \
                      format{ }                               \
              .                                               \
              1024 1024 1024 ext4                             \
                      $primary{ }                             \
                      $bootable{ }                            \
                      method{ format } format{ }              \
                      use_filesystem{ } filesystem{ ext4 }    \
                      mountpoint{ /boot }                     \
              .                                               \
              10240 10240 10240 ext4                          \
                      $lvmok{ }                               \
                      lv_name{ root }                         \
                      method{ format } format{ }              \
                      use_filesystem{ } filesystem{ ext4 }    \
                      mountpoint{ / }                         \
              .                                               \
              15360 15360 15360 ext4                          \
                      $lvmok{ }                               \
                      lv_name{ usr }                          \
                      method{ format } format{ }              \
                      use_filesystem{ } filesystem{ ext4 }    \
                      mountpoint{ /usr }                      \
              .                                               \
              5120 5120 5120 ext4                             \
                      $lvmok{ }                               \
                      lv_name{ opt }                          \
                      method{ format } format{ }              \
                      use_filesystem{ } filesystem{ ext4 }    \
                      mountpoint{ /opt }                      \
              .                                               \
              20480 20480 20480 ext4                          \
                      $lvmok{ }                               \
                      lv_name{ home }                         \
                      method{ format } format{ }              \
                      use_filesystem{ } filesystem{ ext4 }    \
                      mountpoint{ /home }                     \
              .                                               \
              10240 10240 10240 ext4                          \
                      $lvmok{ }                               \
                      lv_name{ var }                          \
                      method{ format } format{ }              \
                      use_filesystem{ } filesystem{ ext4 }    \
                      mountpoint{ /var }                      \
              .                                               \
              5120 5120 5120 ext4                             \
                      $lvmok{ }                               \
                      lv_name{ var-log }                      \
                      method{ format } format{ }              \
                      use_filesystem{ } filesystem{ ext4 }    \
                      mountpoint{ /var/log }                  \
              .                                               \
              2048 2048 2048 ext4                             \
                      $lvmok{ }                               \
                      lv_name{ var-log-audit }                \
                      method{ format } format{ }              \
                      use_filesystem{ } filesystem{ ext4 }    \
                      mountpoint{ /var/log/audit }            \
              .

# LVM confirmation settings
d-i partman-lvm/confirm boolean true
d-i partman-lvm/confirm_nooverwrite boolean true

# Confirm partitioning without asking
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

# File system creation - ext4 for all Linux partitions
d-i partman-basicfilesystems/choose_label string gpt
d-i partman-basicfilesystems/default_label string gpt
d-i partman-partitioning/choose_label string gpt
d-i partman-partitioning/default_label string gpt
d-i partman/choose_label string gpt
d-i partman/default_label string gpt

################################################################################
# BASE SYSTEM INSTALLATION
################################################################################
# Kernel selection - use standard kernel
d-i base-installer/kernel/image string linux-image-amd64

# Don't install recommended packages by default (security/minimalism)
d-i base-installer/install-recommends boolean false

################################################################################
# APT CONFIGURATION - SECURITY HARDENING
################################################################################
# Configure APT for security during installation
d-i apt-setup/cdrom/set-first boolean false
d-i apt-setup/cdrom/set-next boolean false
d-i apt-setup/cdrom/set-failed boolean false

# Use network mirror
d-i apt-setup/use_mirror boolean true

# Enable security updates
d-i apt-setup/services-select multiselect security, updates
d-i apt-setup/security_host string security.debian.org

################################################################################
# PACKAGE SELECTION
################################################################################
# Minimal installation - no desktop environment yet (added by hardening script)
tasksel tasksel/first multiselect standard

# Essential packages for base system and hardening script compatibility
# NOTE: openssh-server is included for remote access during setup but will be
# removed by the hardening script. Git is needed to download the hardening script.
# Both curl and wget are included for compatibility (different tools/scripts may need either).
d-i pkgsel/include string \
    sudo \
    nano \
    curl \
    pamu2fcfg \
    git \
    lvm2 \
    cryptsetup \
    libpam-u2f \
    e2fsprogs \
    firmware-linux-free

# Exclude packages we don't want
# Do not install recommended or suggested packages
d-i pkgsel/install-recommends boolean false
d-i pkgsel/install-suggests boolean false

# Exclude specific package categories
d-i pkgsel/exclude string \
    desktop-base \
    task-desktop \
    task-gnome-desktop \
    task-kde-desktop \
    task-xfce-desktop \
    task-laptop \
    task-print-server \
    cups \
    printer-driver-all \
    sane \
    bluez \
    bluetooth \
    wireless-tools \
    openssh \
    ssh \
    nftables \
    wpasupplicant

# Automatic security updates configuration (optional)
d-i pkgsel/update-policy select unattended-upgrades

# Disable popularity contest for privacy
popularity-contest popularity-contest/participate boolean false

################################################################################
# BOOTLOADER INSTALLATION
################################################################################
# Install GRUB bootloader
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean false

# Install to MBR/ESP
d-i grub-installer/bootdev string /dev/nvme0n1

# GRUB configuration - initial safe parameters
d-i debian-installer/add-kernel-opts string quiet splash ipv6.disable=1

# Optional: GRUB password protection (uncomment to enable)
# Generate password with: grub-mkpasswd-pbkdf2
d-i grub-installer/password-crypted password grub.pbkdf2.sha512.10000...

################################################################################
# FINISHING UP
################################################################################
# Avoid the "installation complete" message
d-i finish-install/reboot_in_progress note

# Power off instead of reboot (change to 'reboot' if preferred)
d-i debian-installer/exit/poweroff boolean false

################################################################################
# PRESEED LATE COMMANDS - POST-INSTALL HARDENING
################################################################################

d-i preseed/late_command string \
    in-target chmod 700 /root ; \
    in-target chmod 700 /home/dev ; \
    in-target chown dev:dev /home/dev ; \
    in-target usermod -aG sudo dev ; \
    in-target getent group wheel >/dev/null || in-target groupadd wheel ; \
    in-target usermod -aG wheel dev ; \
    in-target passwd -l root ; \
    echo "UMASK 077" >> /target/etc/login.defs ; \
    echo "umask 077" >> /target/etc/profile ; \
    echo "umask 077" >> /target/etc/bash.bashrc ; \
    in-target mkdir -p /etc/apt/apt.conf.d ; \
    echo 'APT::Get::AllowUnauthenticated "false";' > /target/etc/apt/apt.conf.d/98-hardening ; \
    echo 'Acquire::http::AllowRedirect "false";' >> /target/etc/apt/apt.conf.d/98-hardening ; \
    echo 'APT::Install-Recommends "false";' >> /target/etc/apt/apt.conf.d/98-hardening ; \
    echo 'APT::Install-Suggests "false";' >> /target/etc/apt/apt.conf.d/98-hardening ; \
    in-target systemctl disable bluetooth 2>/dev/null || true ; \
    in-target systemctl mask bluetooth 2>/dev/null || true ; \
